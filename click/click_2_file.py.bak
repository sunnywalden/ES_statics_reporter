# -*- coding:utf-8 -*-

import time, os


class ClickCalc:
    def __init__(self):
        self.timestamp = time.localtime(time.time() - 24 * 60 * 60)
        self.click_path = '/data/page_source/click/' + time.strftime('%Y/%m/%d/', self.timestamp)
        self.output_path = '/mnt/click/' + time.strftime('%Y/%m/', self.timestamp)
        self.day = time.strftime('%d', self.timestamp)

    def read_click_data(self):
        search_id_dict = {}
        file_list = os.listdir(self.click_path)
        for file in file_list:
            with open(self.click_path + file, 'r') as fs:
                for f in fs:
                    line = f.strip().split('|')
                    search_id = line[4][0:9]
                    if search_id in search_id_dict:
                        search_id_dict[search_id] += 1
                    else:
                        search_id_dict[search_id] = 1
        return search_id_dict

    def write_click_data(self):
        lines = self.read_click_data()
        if not os.path.exists(self.output_path):
            os.makedirs(self.output_path)
        with open(self.output_path + self.day, 'a') as f:
            for key, value in lines.items():
                f.write(str(key) + ':' + str(value) + '\n')


if __name__ == '__main__':
    print 'start handle ......'
    click_calc = ClickCalc()
    click_calc.write_click_data()
